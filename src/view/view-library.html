<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/src/style/shared-styles.html">
<link rel="import" href="/src/element/manga-card.html">
<link rel="import" href="/src/element/tw-api-call.html">
<link rel="import" href="/src/element/iron-grid.html">
<link rel="import" href="/src/behavior/eventhub-behavior.html">

<dom-module id="view-library">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 5px;
            }
            #library_grid {
              height: 100%;
            }
        </style>

        <template is="dom-if" if="[[library_response.success]]" id="grid_hider">
          <iron-grid id="library_grid">
                <template is="dom-repeat" items="[[library_response.response.content]]">
                    <manga-card class="xs6 s4 m2" manga-title="[[item.title]]" manga-id="[[item.id]]"></manga-card>
                </template>
              </iron-grid>
        </template>
        
        <!-- Fetch manga from server -->
        <tw-api-call command="Library" response="{{library_response}}"></tw-api-call>
        <!-- Sync manga across entire browser -->
        <watch-object-filter filtered="{{library_response.response.content}}" type="manga" filter="{{libraryFilter}}" id-param="id"></watch-object>
        <!-- Store any recieved manga information -->
        <watch-object-frozen id="local_manga_db" type="manga" id-param="id"></watch-object-frozen>
        <!-- Recieve search event -->
        <watch-object object="{{librarySearchValue}}" type="LibrarySearchEvent" internal-only></watch-object>
    </template>

    <script>
        Polymer({
            is: 'view-library',

            properties: {
                library_response: {
                    type: Object,
                    notify: true
                },
                libraryFilter: {
                    type: String
                },
                librarySearchValue: {
                    type: String,
                    value: '',
                    notify: true,
                    observer: '_updateLibraryFilter'
                }
            },
            
            behaviors: [EventHubBehavior],

            listeners: {
              'grid_hider.dom-change': 'resizeGrid'
            },

            //The following code below is a HACK to get the grid to resize properly on mobile devices
            //If anybody could find a better solution, that would be great!
            resizeGrid: function() {
              var grid = this.$$("#library_grid");
              if(grid) {
                Polymer.dom(grid).observeNodes(function() {
                  grid.onResize(null, true);
                });
                grid.onResize(null, true);
              }
            },
            attached: function() {
                /*this.ehConn.on("LibrarySearchEvent", function(command) {
                    if(command === "SearchStopped") {
                        _updateLibraryFilter();
                    }
                });*/
                let that = this;
                //TODO Use Function.bind(this); on this
                this.libraryFilter = function(manga) {
                        let valid = manga.favorite;
                        if(valid
                            && that.librarySearchValue !== ''
                            && !manga.title.toLowerCase().includes(that.librarySearchValue.toLowerCase())) {
                            valid = false;
                        }
                        return valid;
                    }.to();
            },
            _updateLibraryFilter: function() {
                this.$.local_manga_db.requestData();
            }
        });
    </script>
</dom-module>
