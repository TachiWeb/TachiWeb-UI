<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-item/paper-item-body.html">
<link rel="import" href="/bower_components/paper-ripple/paper-ripple.html">

<link rel="import" href="/src/element/settings/types/page-change-setting.html">
<link rel="import" href="/src/element/settings/types/single-select-setting.html">
<link rel="import" href="/src/element/settings/types/switch-setting.html">

<dom-module id="settings-item">
  <template>
      <style>
          #pref_item {
              border-bottom: 1px grey;
          }
      </style>
      <paper-item id="pref_item">
          <paper-item-body two-line>
              <div>[[reference.label]]</div>
              <div secondary>[[reference.description]]</div>
          </paper-item-body>
          <template is="dom-if" if="[[equals(reference.type, 'switch')]]" restamp>
            <switch-setting id="setting"value="{{value}}"></switch-setting>
          </template>
          <paper-ripple></paper-ripple>
    </paper-item>
    <!-- TODO Replace this with something magical -->
    <template is="dom-if" if="[[equals(reference.type, 'nested')]]" restamp>
      <page-change-setting id="setting" title="[[reference.label]]" new-schema="[[reference.prefs]]"></page-change-setting>
    </template>
    <template is="dom-if" if="[[equals(reference.type, 'select-single')]]" restamp>
      <single-select-setting id="setting"
      title="[[reference.label]]"
      choices="[[reference.choices]]"
      value="{{value}}"></single-select-setting>
    </template>
  </template>

  <script>
    Polymer({
      is: 'settings-item',
      properties: {
          reference: {
              type: Object
          },
          value: {
            type: Object,
            observer: '_valueChanged'
          },
          optionsState: {
            type: Object
          }
      },
      listeners: {
        'pref_item.tap': '_handleTap'
      },
      observers: [
        '_optionsChanged(reference, optionsState.*)'
      ],
      equals: function(left, right) {
        return left === right;
      },
      _handleTap: function() {
        this.$$("#setting").handleTap();
      },
      _loadValue: function() {
        let newValue = this.get(['optionsState', this.reference.key, 'v']);
        if(newValue === undefined || newValue === null) {
          this.value = this.reference.default;
        } else if(newValue !== this.value) {
          this.value = newValue;
        }
      },
      _optionsChanged: function() {
        if(this.reference.key !== null && this.reference.key !== undefined) {
          this._loadValue();
        }
      },
      _valueChanged: function() {
        let that = this;
          EventHub.emit("OptionsSaveRequest", {
            key: that.reference.key,
            value: that.value,
            type: that.mapType(that.reference.type)
          });
      },
      mapType: function(type) {
        return {
          'select-single': 'String',
          'switch': 'Boolean'
        }[type];
      }
    });
  </script>
</dom-module>
